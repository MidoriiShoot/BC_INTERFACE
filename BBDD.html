import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Search, Database, FileText, Users, Shield, 
  Activity, Check, Menu, X, Home, AlertCircle, Terminal, 
  Settings, Globe, LayoutGrid, Image as ImageIcon,
  GraduationCap, UserMinus, Trophy, ClipboardList,
  Euro, BadgeCheck, BarChart, Layout, Flag, AlertTriangle, 
  Stethoscope, UserCheck, CreditCard, Lock, Hash,
  Copy, ChevronRight, Info, PieChart, MessageSquare, Send, Bot, User, Sparkles
} from 'lucide-react';

// --- BASE DE DATOS MAESTRA ---
const KNOWLEDGE_BASE = [
  {
    id: 'actas',
    title: 'Actas',
    icon: <FileText className="w-5 h-5" />,
    color: 'bg-blue-600',
    items: [
      {
        id: 'a1',
        title: 'Licencia Manual Puesta en el Equipo Equivocado. (JL)',
        type: 'Procedure',
        tags: ['Actas', 'Licencias'],
        note: 'Se cambia el codequipo en nfg_cmp_participantes_actas y se debe revisar si afecta en nfg_cmp_sanciones. Si hay sanción, revisar también nfg_cmp_amonestaciones.'
      },
      {
        id: 'a2',
        title: 'Actas Delegaciones Madrid',
        type: 'SQL',
        tags: ['Incidencia', 'Usuarios'],
        description: 'Causa habitual: El usuario del árbitro en la delegación no coincide con el de Madrid o no está vinculado correctamente en nfg_cmp_arbitros_guf_usuarios.',
        content: `-- 1. Verificar usuario y vínculo (Madrid)
SELECT * FROM ffm.guf_usuarios g 
JOIN ffm.nfg_cmp_arbitros_guf_usuarios ag ON ag.codusuario=g.cod_usuario 
JOIN ffm.nfg_cmp_arbitros a ON a.codarbitro=ag.codarbitro 
WHERE g.cod_portal=100 AND a.codigo_colegiado='8Y142';

-- 2. Comprobar usuario en delegación
SELECT * FROM del.guf_usuarios WHERE codigo_usr='9319804';  -- delegación
SELECT * FROM ffm.guf_usuarios WHERE codigo_usr='9319804';  -- Madrid

-- 3. Ver/actualizar contraseña (deben coincidir)
SELECT AES_DECRYPT(clave1,'FFM05307') FROM ffm.guf_usuarios WHERE codigo_usr='2939163';

-- Actualizar en delegación (añadiendo las x)
UPDATE del.guf_usuarios SET clave1=AES_ENCRYPT('x123Sofiax','FFM05307') WHERE codigo_usr='2939163';

-- 4. Revisar vínculo árbitro–usuario
SELECT * FROM nfg_cmp_arbitros_guf_usuarios WHERE codarbitro=100229823;`
      },
      {
        id: 'a3',
        title: 'Detectar Antes de Partido Actas que No podran Abrir',
        type: 'SQL',
        tags: ['Incidencia', 'Árbitros'],
        description: 'Detectar árbitros que no disponen de usuario en la delegación correspondiente al partido designado.',
        content: `SELECT 
    da.codarbitro,
    g.codigo_usr,
    d.coddesignacion,
    SUBSTR(p.referencia,1,3) AS numero_delegacion,
    del.cod_portal AS cod_portal_del_usuario
FROM ffm.nfg_ca_designaciones_arbitros da
JOIN ffm.nfg_ca_designaciones d ON da.cod_portal = d.cod_portal AND da.coddesignacion = d.coddesignacion
JOIN ffm.nfg_ca_partidos p ON p.coddesignacion = d.coddesignacion AND p.cod_portal = d.cod_portal
JOIN ffm.nfg_cmp_arbitros_guf_usuarios ag ON ag.codarbitro = da.codarbitro AND ag.cod_portal = 100
JOIN ffm.guf_usuarios g ON g.cod_usuario = ag.codusuario AND g.cod_portal = ag.cod_portal
LEFT JOIN del.guf_usuarios del ON del.codigo_usr = g.codigo_usr AND CAST(del.cod_portal AS UNSIGNED) = CAST(SUBSTR(p.referencia,1,3) AS UNSIGNED)
WHERE d.no_federado = 1
  AND CAST(d.fecha_partido AS DATE) BETWEEN '2025-10-24' AND '2025-10-26'
  AND SUBSTR(p.referencia,1,3) IS NOT NULL
  AND SUBSTR(p.referencia,1,3) <> ''
  AND del.cod_portal IS NULL
ORDER BY numero_delegacion, d.coddesignacion, g.codigo_usr;`
      },
      {
        id: 'a4',
        title: 'Regenerar PDF Actas / Regenerar Actas PDF',
        type: 'Procedure',
        tags: ['Batch', 'PDF'],
        description: 'Regenerar actas por batch. Cambiar el codacta por las actas y comprobar antes de lanzar.',
        content: `INSERT INTO n_batch_exec (
 COD_PORTAL, NUM_COLA, COD_USUARIO, FECHA_ALTA, FECHA_INICIO, EXE_PROCESO, EXE_COD_USUARIO, EXE_PARAMETROS
)
SELECT 100,1,101,NOW(),NOW(),"NFG_Activar_RegenerarPDFActas_batch",101,CONCAT("cod_primaria=1000127&codigos_actas=",codacta)
FROM nfg_cmp_actas a
WHERE a.cod_portal=100
AND a.cerrada=1
-- Añadir filtros aquí (Ej: AND codacta IN(...) o AND coddelegado_campo=-1 AND codtemporada=21);`
      }
    ]
  },
  {
    id: 'arbitros',
    title: 'Árbitros',
    icon: <UserCheck className="w-5 h-5" />,
    color: 'bg-red-500',
    items: [
      {
        id: 'ar1',
        title: 'Renovaciones Árbitros',
        type: 'SQL',
        tags: ['Incidencia'],
        description: 'Si el checkbox para iniciar el proceso de renovación no puede seleccionarse.',
        content: `SELECT * FROM nfg_cmp_arbitros_moderar WHERE finalizar = 0 AND SOLICITAR_COLEGIACION = 0`
      },
      {
        id: 'ar2',
        title: 'Informe número de designaciones por árbitro y competición',
        type: 'SQL',
        tags: ['Informe'],
        description: 'Informe para Árbitros, Asistentes, Informadores y Contrainformadores.',
        content: `-- ARBITROS Y ASISTENTES
SELECT IF(a.codtipo_arbitro=100,(SELECT descripcion FROM nfg_cmp_categorias_arbitros...),...) Categoria,
a.codigo_colegiado, a.NOMBRE_ARBITRO, nombre_competicion, IF(da.orden=1,'Árbitro','Asistente') Tipo,
COUNT(da.CODDESIGNACION) designaciones
FROM nfg_cmp_arbitros a, nfg_ca_designaciones d, nfg_ca_designaciones_arbitros da
WHERE a.cod_portal=100 AND d.ESTADO=1 AND d.CODTEMPORADA=20...
GROUP BY a.codarbitro, d.nombre_competicion, Tipo;

-- INFORMADORES
SELECT ... IF(da.orden=6,'Delegado de partido','Asistente') Tipo...
FROM nfg_cmp_arbitros a... nfg_ca_designaciones_arbitros da...

-- CONTRAINFORMADORES
SELECT ... 'Contrainformador' Tipo...
FROM nfg_cmp_arbitros a... nfg_ca_designaciones_contrainformadores da...`
      },
      {
        id: 'ar3',
        title: 'Informe-Clasificación de Arb/Asis por media de los 10 primeros informes',
        type: 'SQL',
        tags: ['Informe', 'Clasificación'],
        content: `SELECT codigo_colegiado, nombre_arbitro, AVG(puntuacion) AS puntuacion_media, COUNT(DISTINCT coddesignacion) AS total_informes
FROM (
  SELECT ordered.*, @rn := IF(@prev_codarbitro = ordered.codarbitro, @rn + 1, 1) AS rn, @prev_codarbitro := ordered.codarbitro
  FROM (SELECT da.codarbitro, da.puntuacion... FROM ... ORDER BY da.codarbitro, d.fecha_partido) AS ordered,
  (SELECT @rn := 0, @prev_codarbitro := NULL) vars
) AS sub
WHERE rn <= 10
GROUP BY codarbitro ORDER BY puntuacion_media DESC;`
      },
      {
        id: 'ar4',
        title: 'Sacar puntuación media de la clasificación arbs/asis',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT a.codigo_colegiado, a.nombre_arbitro, AVG(da.puntuacion) AS media, COUNT(DISTINCT da.CODDESIGNACION) AS total_partidos
FROM nfg_cmp_arbitros a, nfg_ca_designaciones_arbitros da, nfg_ca_designaciones d, nfg_ca_informes i
WHERE ... AND da.puntuacion > 0
GROUP BY a.codarbitro
ORDER BY AVG(da.puntuacion) DESC`
      },
      {
        id: 'ar5',
        title: 'Designaciones sin Informes Generados',
        type: 'SQL',
        tags: ['Control'],
        content: `SELECT * FROM nfg_ca_designaciones_arbitros d
WHERE d.cod_portal=100 AND d.codtemporada=21 AND d.codtipo_arbitro=105
AND NOT EXISTS(SELECT 1 FROM nfg_ca_informes i WHERE i.cod_portal=100 AND i.coddesignacion = d.coddesignacion)`
      },
      {
        id: 'ar6',
        title: 'Activar autoevaluaciones',
        type: 'Procedure',
        tags: ['Configuración'],
        description: 'Configuración de parámetros y plantillas para autoevaluación.',
        content: `Parámetros:
CA_Autoevaluacion -> True
CA_Categorias_Autoevaluacion -> códigos de categorías
CA_InformeAutoCuestionario -> 1394965
CA_InformeAutoCuestionarioAsistentes -> 101497958

Plantillas a duplicar: NFG_CA_GstInformesAutoMng_(ffgalicia).html, etc.

INSERTS CUESTIONARIOS:
INSERT INTO nfg_ca_cuestionarios (...) VALUES (100,1394965,1009226,21,'FFM Autoevaluación'...);
INSERT INTO nfg_ca_cuestionarios_apartados (...) VALUES ...`
      },
      {
        id: 'ar7',
        title: 'Cambiar liquidación/recibo de equipo 59487(MA)',
        type: 'SQL',
        tags: ['Gestión Económica'],
        content: `UPDATE nfg_cf_saldos SET clave_acceso= *codigo club* WHERE cod_portal=100 AND coddesignacion=...`
      },
      {
        id: 'ar8',
        title: 'Generación cuotas (arbitraje)',
        type: 'SQL',
        tags: ['Gestión Económica'],
        description: 'Generar automáticamente el tercer plazo de cuotas a todos los árbitros activos.',
        content: `SET @numero=0;
INSERT INTO nfg_ca_cuotas (cod_portal, codcuota, codarbitro, codtarifa, cod_temporada, fecha, importe, descripcion, estado...)
SELECT 100, @numero:=@numero+1, b.codarbitro, d.codtarifa, 21, NOW(), d.importe, CONCAT(d.descripcion,' (2025-2026)'), 0...
FROM nfg_cmp_arbitros b, nfg_cmp_categorias_arbitros c, nfg_ca_tarifas d
WHERE b.cod_portal=100 AND b.estado=1 AND b.fecha_baja IS NULL
AND c.codcategoria=b.categoria_arbitro AND c.principal=1 AND d.tipo_tarifa=6...
UNION
SELECT ... FROM nfg_cmp_arbitros b, nfg_cmp_categorias_asistentes c, nfg_ca_tarifas d ...`
      },
      {
        id: 'ar9',
        title: 'Recuperar designación original borrada de un partido reasignado (estado=4)',
        type: 'Procedure',
        tags: ['Designaciones'],
        content: `1. Localizar designación borrada:
SELECT * FROM nfg_ca_designaciones_Arbitros WHERE cod_portal=100 AND codarbitro=... AND codtemporada=21

2. En la designación poner Estado=1 y Codacta correcto.
3. En nfg_cmp_actas poner coddesignacion recuperada.
4. Insertar de nuevo en nfg_cmp_arbitros_Actas.`
      },
      {
        id: 'ar10',
        title: 'Si no sale el partido para designar',
        type: 'Note',
        tags: ['Designaciones', 'Incidencia'],
        note: 'A revisar: Hora del partido, Campo asignado, Delegación (si se usa), TODOS EN EL MISMO COMITÉ, Comarca.'
      }
    ]
  },
  {
    id: 'aula',
    title: 'Aula Virtual y Escuelas',
    icon: <GraduationCap className="w-5 h-5" />,
    color: 'bg-indigo-500',
    items: [
      {
        id: 'aul1',
        title: 'Recuperar Preguntas',
        type: 'SQL',
        tags: ['Formación'],
        description: 'Query para recuperar las respuestas de los test.',
        content: `INSERT INTO nfg_av_respuestas (COD_PORTAL, COD_RESPUESTA, COD_PREGUNTA_GENERAL...)
SELECT 100, rc.cod_respuesta, pc.cod_pregunta_general...
FROM NFG_AV_tests_respuestas_configuracion rc, nfg_av_tests_preguntas_configuracion pc
WHERE rc.cod_portal = 100 AND pc.cod_portal = 100 AND pc.cod_pregunta = rc.cod_pregunta
AND rc.cod_pregunta IN (SELECT o.cod_pregunta FROM nfg_av_test_ordenacion o WHERE o.cod_test = 51671585...)
AND NOT EXISTS (SELECT 1 FROM nfg_av_respuestas r WHERE r.cod_portal = 100 AND r.cod_pregunta_general = pc.cod_pregunta_general)`
      }
    ]
  },
  {
    id: 'baja',
    title: 'Baja Equipos',
    icon: <UserMinus className="w-5 h-5" />,
    color: 'bg-slate-500',
    items: [
      {
        id: 'baj1',
        title: 'Baja Equipos EQUIPOS NO RENOVADOS SIN BAJA',
        type: 'SQL',
        tags: ['Equipos'],
        content: `SELECT l.* FROM nfg_licencias l 
WHERE l.cod_portal = 100 AND l.fecha_baja IS NULL AND l.fecha_limite >= '2026-06-30'
AND EXISTS (SELECT 1 FROM nfg_equipos e WHERE e.cod_portal = 100 AND IFNULL(e.inscrito, 0) = 0 AND e.fecha_baja IS NULL AND e.codigo_equipo = l.codigo_equipo);

SELECT e.* FROM nfg_equipos e WHERE ...`
      }
    ]
  },
  {
    id: 'comp',
    title: 'Competiciones',
    icon: <Trophy className="w-5 h-5" />,
    color: 'bg-yellow-500',
    items: [
      {
        id: 'com1',
        title: 'Añadir/Modificar categoría relacionadas o principales. (GR)',
        type: 'Procedure',
        tags: ['Configuración'],
        description: 'El orden indica cual es la categoría principal (0) o relacionada (1).',
        content: `Se añade en nfg_cmp_competiciones_categorias.
0 -> Categoría Principal
1 -> Para las demás categorías`
      },
      {
        id: 'com2',
        title: 'Cambia Temporada Playa',
        type: 'SQL',
        tags: ['Update'],
        content: `-- Sacamos los grupos
SELECT GROUP_CONCAT(codgrupo) FROM nfg_cmp_grupos WHERE ... codcompeticion IN (SELECT codcompeticion ... WHERE codigo_tipo_juego = 5 AND codtemporada = 21);

-- ACTAS:
UPDATE nfg_cmp_actas a SET a.codtemporada=20 WHERE ...;
-- SANCIONES:
UPDATE nfg_cmp_sanciones s... SET s.cod_temporada=20 ...;
-- DESIGNACIONES, ARBITROS, COMPETICIONES... (Ver script completo)`
      },
      {
        id: 'com3',
        title: 'PDF no salen equipos participantes',
        type: 'SQL',
        tags: ['Incidencia'],
        content: `SELECT e.codequipo, MIN(e.codtemporada) AS codtemporada_equipo, c.codtemporada AS codtemporada_club...
FROM nfg_cmp_clubes c JOIN nfg_cmp_equipos e ...
WHERE e.cod_portal = 100 AND comp.codtemporada = 21
AND c.codtemporada = 20
AND NOT EXISTS (SELECT 1 FROM nfg_cmp_clubes c2 WHERE c2.codclub=c.CODCLUB AND c2.CODTEMPORADA=21)`
      },
      {
        id: 'com4',
        title: 'Cambio de equipo en una competición ya empezada (MA) 59406',
        type: 'Procedure',
        tags: ['Incidencia'],
        description: 'Tablas afectadas si el equipo no ha jugado.',
        content: `nfg_cmp_grupos_equipos
nfg_cmp_actas
nfg_cmp_partidos
nfg_ca_designaciones
nfg_cmp_historico_sanciones
nfg_cmp_participantes_actas
nfg_cmp_sanciones
nfg_cmp_clasificaciones
nfg_cmp_cartas`
      },
      {
        id: 'com5',
        title: 'Añadir equipos a partido a vuelta. Ticket 59259 (MA)',
        type: 'Procedure',
        tags: ['Incidencia'],
        description: 'Cuando en las rondas aparece el estado como finalizada y los partidos no tienen equipos.',
        content: `Se pone el codequipo_casa y codequipo_fuera en:
- nfg_cmp_partidos
- nfg_cmp_actas`
      },
      {
        id: 'com6',
        title: 'Añadir competición con la que comparte sanciones. (GR)',
        type: 'Procedure',
        tags: ['Configuración'],
        description: 'Se añade en nfg_cmp_comp_comp. Codtipo_compartir: 1 (Todas), 2 (Menos amonestaciones).',
        content: `Se debe añadir la competición con su relacionada en nfg_cmp_comp_comp.
Se añade en ambos sentidos.`
      },
      {
        id: 'com7',
        title: 'Fechas de la última jornada de cada competición',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT c.nombre_competicion competicion, g.nombre grupo, MAX(fj.fecha) ultima_jornada
FROM nfg_cmp_competiciones c, nfg_cmp_grupos g, nfg_cmp_fechas_jornadas fj
WHERE c.CODCOMPETICION=g.CODCOMPETICION AND g.CODGRUPO=fj.CODGRUPO AND c.CODTEMPORADA=20
GROUP BY g.codgrupo ORDER BY c.orden, g.ORDEN`
      },
      {
        id: 'com8',
        title: 'Asignar fecha de la Jornada a los partidos',
        type: 'SQL',
        tags: ['Update'],
        content: `UPDATE nfg_cmp_actas a, nfg_cmp_fechas_jornadas f
SET a.fecha=f.fecha
WHERE a.codgrupo=... AND a.jornada=f.CODJORNADA`
      },
      {
        id: 'com9',
        title: 'Eliminar Horarios de Partidos por Campo',
        type: 'SQL',
        tags: ['Incidencia'],
        content: `UPDATE nfg_cmp_historico_horarios SET cod_portal=99 WHERE ...;
UPDATE nfg_cmp_actas SET comienzo1=NULL WHERE ...;`
      }
    ]
  },
  {
    id: 'ent',
    title: 'Entrenadores',
    icon: <ClipboardList className="w-5 h-5" />,
    color: 'bg-teal-600',
    items: [
      {
        id: 'ent1',
        title: 'Añadir plantilla a una clase de contrato. 59337',
        type: 'Procedure',
        tags: ['Configuración'],
        content: `Introducir en una clase de contrato una plantilla Plantilla, simplemente añadiendo en la tabla nfg_ce_clases_contrato en el campo plantilla, el nombre de la plantilla del contrato.`
      },
      {
        id: 'ent2',
        title: 'Modificar en Guipúzcoa Importe de cuota que ya se pago',
        type: 'SQL',
        tags: ['Corrección'],
        content: `SELECT * FROM nfg_ce_cuotas WHERE ...;
SELECT * FROM nfg_ce_movimientos WHERE ...;
SELECT * FROM nfg_ce_recibos WHERE ...;
SELECT * FROM nfg_caja_movimientos WHERE ...;`
      },
      {
        id: 'ent3',
        title: 'URL´s inscripción online',
        type: 'Note',
        tags: ['Listado'],
        note: '• Baleares – FFIB - https://www.ffib.es/Fed/NPcd/NFG_EA_GstInscripcion?cod_primaria=5001335\n• Rioja - FRF - https://www.frfutbol.com/pnfg/NPcd/NFG_EA_GstInscripcion?cod_primaria=5001395 \n... (Ver resto en documento original)'
      },
      {
        id: 'ent4',
        title: 'Entrenadores con Fotos en el Histórico',
        type: 'SQL',
        tags: ['Imágenes'],
        content: `SELECT li.* FROM nfg_licencias_imagenes li, nfg_licencias l WHERE li.es_historico = 1 AND li.TIPO_IMAGEN = 2...`
      },
      {
        id: 'ent5',
        title: 'Eliminar cuotas',
        type: 'SQL',
        tags: ['Corrección'],
        content: `SELECT * FROM nfg_ce_cuotas -- Cambiar Estado a 4 y borrar cod_liqudiación
SELECT * FROM nfg_ce_movimientos -- Cambiar Cod_Portal a 90
SELECT * FROM nfg_ce_recibos`
      },
      {
        id: 'ent6',
        title: 'Actualizar cuotas pagadas',
        type: 'SQL',
        tags: ['Corrección'],
        content: `SELECT * FROM nfg_ce_cuotas...
SELECT * FROM nfg_ce_movimientos... -- Cambiar saldo y debe
SELECT * FROM nfg_ce_recibos... -- Cambiar importe total
SELECT * FROM nfg_caja_movimientos... -- Cambiar importe a 0`
      },
      {
        id: 'ent7',
        title: 'Eliminar entrenador',
        type: 'Procedure',
        tags: ['Baja'],
        content: `nfg_ce_personas_inscritas, nfg_ce_inscritos_imagenes
nfg_ce_personas, nfg_ce_cuotas
nfg_ce_entrenadores_guf_usuarios
...`
      },
      {
        id: 'ent8',
        title: '"Fusionar" entrenadores CTE',
        type: 'SQL',
        tags: ['Mantenimiento'],
        content: `SELECT * FROM nfg_ce_personas WHERE cod_licencia IN (...)
SELECT * FROM nfg_ce_carnets...
... (Consultar todas las tablas listadas)`
      }
    ]
  },
  {
    id: 'gen',
    title: 'General',
    icon: <Settings className="w-5 h-5" />,
    color: 'bg-gray-600',
    items: [
      {
        id: 'gen1',
        title: 'Temporada por defecto en filtros. 59254 (JL)',
        type: 'Config',
        tags: ['UX'],
        content: `SELECT cod_temporada, nombre FROM nfg_temporadas WHERE cod_portal = $cod_portal AND cod_temporada <= $q$(num)cod_temporada_actual ORDER BY nombre DESC LIMIT 5`
      },
      {
        id: 'gen2',
        title: 'Posible motivo del no acceso a la intranet: IP baneada.',
        type: 'Procedure',
        tags: ['Acceso'],
        content: `Eliminar el baneo desde la tabla n_ipbanned.`
      },
      {
        id: 'gen3',
        title: 'TARJETAS PARA PAGAR PRUEBAS (MA)',
        type: 'Note',
        tags: ['Pruebas'],
        note: '- Aceptada: 4548812049400004 (12/23, 123, 123456)\n- Denegada: 1111 1111 1111 1117'
      },
      {
        id: 'gen4',
        title: 'Desencriptar contraseña',
        type: 'SQL',
        tags: ['Seguridad'],
        content: `SELECT AES_DECRYPT(clave1,'PRM_GU_EncriptacionClave1') FROM guf_usuarios WHERE codigo_usr='...';`
      },
      {
        id: 'gen5',
        title: 'Buscar columnas en base de datos',
        type: 'SQL',
        tags: ['Dev'],
        content: `SELECT DISTINCT TABLE_NAME TABLA FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME LIKE "cod_persona" AND TABLE_SCHEMA="ffaragon";`
      },
      {
        id: 'gen6',
        title: 'Saltarse Foreign KEY',
        type: 'SQL',
        tags: ['Admin'],
        content: `SET FOREIGN_KEY_CHECKS=0`
      }
    ]
  },
  {
    id: 'eco',
    title: 'Gestión Económica',
    icon: <Euro className="w-5 h-5" />,
    color: 'bg-emerald-600',
    items: [
      {
        id: 'eco1',
        title: 'Mover una liquidación de caja. (GR)',
        type: 'Procedure',
        tags: ['Contabilidad'],
        description: 'Cambio excepcional. Tablas afectadas: nfg_boletin, nfg_caja_movimientos, nfg_gc_liquidaciones.',
        content: `UPDATE nfg_caja_movimientos SET cod_caja = [NUEVA_CAJA] WHERE cod_liquidacion = [CODIGO];`
      },
      {
        id: 'eco2',
        title: 'Facturación',
        type: 'Note',
        tags: ['Info'],
        note: 'Verificar procedimientos de facturación.'
      },
      {
        id: 'eco3',
        title: 'Pago por transferencia no asociado MA (4463)',
        type: 'SQL',
        tags: ['Incidencia'],
        content: `SELECT f.ID_PERSONA, f.NOMBRE... FROM nfg_pf_operaciones_pasarela o, nfg_pf_federados f WHERE ...`
      },
      {
        id: 'eco4',
        title: 'Métodos de Pago en Ingresos Saldos Online',
        type: 'Note',
        tags: ['Configuración'],
        note: 'Revisar tabla nfg_forma_pagos.'
      },
      {
        id: 'eco5',
        title: 'Cambiar liquidación/recibo de equipo 59487(MA)',
        type: 'SQL',
        tags: ['Corrección'],
        content: `UPDATE nfg_cf_saldos SET clave_acceso= *codigo club* WHERE cod_portal=100 AND coddesignacion=...`
      }
    ]
  },
  {
    id: 'lic',
    title: 'Licencias',
    icon: <BadgeCheck className="w-5 h-5" />,
    color: 'bg-green-600',
    items: [
      {
        id: 'li1',
        title: 'Eliminar fichero de petición en la tramitación. (GR)',
        type: 'Procedure',
        tags: ['Tramitación'],
        content: `Se cambia el cod_portal a 90 en nfg_ficheros_adjuntos_pre.`
      },
      {
        id: 'li2',
        title: 'Buscar evento alta sin activacion de licencia',
        type: 'SQL',
        tags: ['Incidencia'],
        content: `SELECT DISTINCT e.id_persona FROM nfg_rfef_com_eventos e WHERE ... AND e.codigo_barras NOT IN (SELECT codigo_barras FROM nfg_historico ...)`
      },
      {
        id: 'li3',
        title: 'Carga Externa',
        type: 'Note',
        tags: ['Info'],
        note: 'Solo se pasan los documentos 1 vez al día (1:30h). Solo se puede pasar un único documento del mismo tipo al día.'
      },
      {
        id: 'li4',
        title: 'Recuperar licencia borrada. (MA)',
        type: 'SQL',
        tags: ['Insert', 'Emergencia'],
        content: `INSERT INTO nfg_licencias (...) SELECT ... FROM nfg_licencias_borradas WHERE ...`
      },
      {
        id: 'li5',
        title: 'Regeneración de imagen activa en licencias',
        type: 'Procedure',
        tags: ['Configuración'],
        content: `Revisar nfg_tipos_ficheros. Campo ES_Licencia debe ser 2.`
      },
      {
        id: 'li6',
        title: 'Licencias sin codigo barras 63419',
        type: 'SQL',
        tags: ['Corrección'],
        content: `UPDATE nfg_licencias l, nfg_licencias_imagenes i, nfg_tipos_licencias tl, nfg_tipos_ficheros tf...`
      },
      {
        id: 'li7',
        title: 'Cambiar Periodos de Inscripción en las Categorías. 59230 (MA)',
        type: 'Procedure',
        tags: ['Configuración'],
        content: `1. Actualizar nfg_categorias (insequipos_inicio, etc).
2. Revisar parámetro GC_InscGolEq_FechaPeriodo.
3. Lanzar NPcd/NFG_Inscripcion_Online_Equipos_Resetear?resetear=1`
      },
      {
        id: 'li8',
        title: 'Mandar imagen a historico 62290',
        type: 'SQL',
        tags: ['Mantenimiento'],
        content: `SELECT CONCAT('update nfg_licencias_imagenes set es_historico=1...') ...`
      },
      {
        id: 'li9',
        title: 'Plantilla vinculaciones',
        type: 'Note',
        tags: ['Info'],
        note: 'Es NFG_PF_MntFEderado, desde el proyecto clubes, nfg_pf'
      },
      {
        id: 'li10',
        title: 'Documentos pedidos 65176',
        type: 'SQL',
        tags: ['Tramitación'],
        description: 'Query para diagnosticar por qué no salen documentos pedidos.',
        content: `SELECT * FROM (SELECT tf.nombre AS tipo_documento... FROM nfg_ficheros_adjuntos_pre fa... WHERE l.codigo_licencia = '14243708'...)`
      },
      {
        id: 'li11',
        title: 'Query de insert a nfg_cmp_equipos',
        type: 'SQL',
        tags: ['Equipos'],
        content: `INSERT INTO nfg_cmp_equipos (...) SELECT ... FROM nfg_equipos ...`
      },
      {
        id: 'li12',
        title: 'Personas con licencias activas que tienen un equipo y club',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT l.nombre... FROM nfg_licencias l, nfg_clubes c, nfg_equipos e ...`
      },
      {
        id: 'li13',
        title: 'Licencias sin límite (Baja de licencias)',
        type: 'SQL',
        tags: ['Control'],
        content: `SELECT l.id_persona... FROM nfg_licencias l... WHERE l.fecha_limite IS NULL`
      },
      {
        id: 'li14',
        title: 'Añadir firma a documentos on line',
        type: 'Procedure',
        tags: ['Configuración'],
        content: `Cambiar en nfg_tipos_ficheros firmas_configuradas=1`
      }
    ]
  },
  {
    id: 'mut',
    title: 'Mutualidad',
    icon: <Stethoscope className="w-5 h-5" />,
    color: 'bg-rose-500',
    items: [
      {
        id: 'mu1',
        title: 'INFORME Número de reconocimientos médicos entre un rango de fechas de cada clínica [MA] 59350',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT kk.medico, kk.clinica... FROM (SELECT cod_clinica1... UNION SELECT cod_clinica2...)`
      },
      {
        id: 'mu2',
        title: 'INFORME: intervenciones quirúrgicas correspondientes a los años XX',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT ... FROM mf_hm_revisiones_actos_medicos ram... WHERE ram.cod_acto_medico=18...`
      },
      {
        id: 'mu3',
        title: 'Volcar alta/baja médica',
        type: 'Procedure',
        tags: ['Sincronización'],
        content: `Enviado a NULL en nfg_historial_medico + Lanzar NFG_MF_Eventos_RecepcionSiniestro`
      },
      {
        id: 'mu4',
        title: 'Cambio ID mutualista',
        type: 'SQL',
        tags: ['Corrección'],
        content: `SELECT * FROM MF_MUTUALISTAS... SELECT * FROM nfg_historial_medico...`
      },
      {
        id: 'mu5',
        title: 'Volcar cuota de mut a fed 64072',
        type: 'Procedure',
        tags: ['Batch'],
        content: `INSERT INTO mfsscc.n_batch_exec ... 'adm_envio_cuotas'`
      },
      {
        id: 'mu6',
        title: 'Tareas programadas',
        type: 'Note',
        tags: ['Info'],
        note: 'NFG_MF_Eventos_TareasPeriodicas, NFG_MF_Eventos_Recepcion_Reconocimientos'
      },
      {
        id: 'mu7',
        title: 'Contabilizar boletines 4836',
        type: 'Procedure',
        tags: ['Batch'],
        content: `INSERT INTO n_batch_exec ... 'MF_Cont_EnvioBoletin_Delegaciones_Hist'`
      },
      {
        id: 'mu8',
        title: 'Volcar rec. médicos',
        type: 'Procedure',
        tags: ['Integración'],
        content: `NFG_MF_Eventos_Recepcion_Reconocimientos -> MF_MUT_API`
      },
      {
        id: 'mu9',
        title: 'Alta/Baja médica fechas incorrectas',
        type: 'Note',
        tags: ['Corrección'],
        note: 'Cambiar en nfg_historial_medico: fecha, fecha_lesion, fecha_recuperacion.'
      }
    ]
  },
  {
    id: 'inf',
    title: 'Petición de informes',
    icon: <BarChart className="w-5 h-5" />,
    color: 'bg-cyan-600',
    items: [
      {
        id: 'inf1',
        title: 'Nº licencias/club/cat(65188)',
        type: 'SQL',
        tags: ['Estadística'],
        content: `SELECT c.clave_acceso, c.nombre, GROUP_CONCAT... FROM NFG_EQUIPOS e...`
      }
    ]
  },
  {
    id: 'por',
    title: 'Portal Federado',
    icon: <Layout className="w-5 h-5" />,
    color: 'bg-violet-600',
    items: [
      {
        id: 'por1',
        title: 'Email/teléfono bloqueado',
        type: 'SQL',
        tags: ['Incidencia'],
        content: `SELECT * FROM nfg_licencias WHERE telefono = X;
SELECT * FROM nfg_clubes WHERE...`
      }
    ]
  },
  {
    id: 'rfe',
    title: 'RFEF',
    icon: <Flag className="w-5 h-5" />,
    color: 'bg-red-700',
    items: [
      {
        id: 'rfe1',
        title: 'Cambiar estado de un tipo de aviso RFEF de licencias',
        type: 'SQL',
        tags: ['Update'],
        content: `UPDATE nfg_rfef_com_lic_avisos l... SET estado=1 WHERE cod_mensaje=250`
      },
      {
        id: 'rfe2',
        title: 'Avisos RFEF (botones) 64709',
        type: 'Procedure',
        tags: ['Configuración'],
        content: `Revisar tabla nfg_rfef_com_mensajes y plantilla NFG_RFEF_COM_Mensaje.html`
      }
    ]
  },
  {
    id: 'san',
    title: 'Sanciones',
    icon: <AlertTriangle className="w-5 h-5" />,
    color: 'bg-orange-600',
    items: [
      {
        id: 'san1',
        title: 'Informe Tarjetas por Equipo de una Competición',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT ... FROM nfg_cmp_grupos gr... WHERE gr.codcompeticion = ...`
      },
      {
        id: 'san2',
        title: 'Revisar sanciones',
        type: 'Note',
        tags: ['Info'],
        note: 'Tipos: 100 (1ª), 111 (2ª), 112 (3ª), 101 (Acumulación), 102 (Doble), 103 (Roja)'
      },
      {
        id: 'san3',
        title: 'Informe Tarjetas por Equipo de un Grupo',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT ... FROM nfg_cmp_grupos gr... WHERE gr.codgrupo = ...`
      }
    ]
  },
  {
    id: 'sel',
    title: 'Selecciones',
    icon: <Users className="w-5 h-5" />,
    color: 'bg-pink-600',
    items: [
      {
        id: 'sel1',
        title: 'Censo jugadores / técnicos / delegados / otros mayores de 18 (Elegibles)',
        type: 'SQL',
        tags: ['Censo'],
        content: `SELECT ... WHERE l.fecha_nacimiento <= ADDDATE(NOW(), INTERVAL -18 YEAR)...`
      },
      {
        id: 'sel2',
        title: 'Censo jugadores / técnicos / delegados / otros mayores de 16 (Electores)',
        type: 'SQL',
        tags: ['Censo'],
        content: `SELECT ... WHERE l.fecha_nacimiento <= ADDDATE(NOW(), INTERVAL -16 YEAR)...`
      },
      {
        id: 'sel3',
        title: 'Censos Árbitro / Asistentes / Informadores / Otros mayores de 18 (ELEGIBLES)',
        type: 'SQL',
        tags: ['Censo'],
        content: `SELECT ... FROM nfg_cmp_arbitros ca WHERE ... INTERVAL -18 YEAR...`
      },
      {
        id: 'sel4',
        title: 'Censos Árbitro / Asistentes / Informadores / Otros mayores de 16 (ELECTORES)',
        type: 'SQL',
        tags: ['Censo'],
        content: `SELECT ... FROM nfg_cmp_arbitros ca WHERE ... INTERVAL -16 YEAR...`
      },
      {
        id: 'sel5',
        title: 'Informe Jugadores Convocados en más de una Selección',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT ... HAVING COUNT(DISTINCT s.cod_seleccion) > 1`
      },
      {
        id: 'sel6',
        title: 'Informe Jugadores Convocados por Selecciones Elegidas',
        type: 'SQL',
        tags: ['Informe'],
        content: `SELECT ... WHERE c.cod_seleccion IN (...)`
      },
      {
        id: 'sel7',
        title: 'USUARIOS alineaciones',
        type: 'Procedure',
        tags: ['Incidencia'],
        content: `Borrar asociacion usuario_convocatoria en nfg_sel_asociados_guf_usuarios.`
      }
    ]
  },
  {
    id: 'tra',
    title: 'Traducciones',
    icon: <Globe className="w-5 h-5" />,
    color: 'bg-amber-500',
    items: [
      {
        id: 'tra1',
        title: 'Path cambio cabeceras y pies de la web',
        type: 'Note',
        tags: ['Ruta'],
        note: '\\\\192.168.10.216\\Proyectos\\NOVA_INST\\Diseno\\web_responsive_2\\base\\SistemaNavegacion\\html'
      },
      {
        id: 'tra2',
        title: 'Cambiar traducción del menú',
        type: 'Note',
        tags: ['Configuración'],
        note: 'Se cambia en la propia territorial, ya que los menús son individuales.'
      },
      {
        id: 'tra3',
        title: 'Traducción',
        type: 'Procedure',
        tags: ['Configuración'],
        content: `Se hace la traducción en clubes, en n_idiomastextos. Instalar plantillas en FT.`
      }
    ]
  }
];

// --- COMPONENTE NOTIFICACIÓN TOAST ---
const Toast = ({ message, onClose }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);

  return (
    <div className="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center space-x-3 animate-fade-in-up z-50">
      <Check className="w-5 h-5 text-green-400" />
      <span className="font-medium">{message}</span>
    </div>
  );
};

// --- COMPONENTE BREADCRUMBS ---
const Breadcrumbs = ({ category, item, onHome, onCategory }) => {
  return (
    <nav className="flex items-center space-x-2 text-sm text-gray-500 mb-6 bg-white px-4 py-2 rounded-lg shadow-sm w-fit">
      <button onClick={onHome} className="hover:text-blue-600 flex items-center transition-colors">
        <Home className="w-4 h-4 mr-1" />
        Inicio
      </button>
      {category && (
        <>
          <ChevronRight className="w-4 h-4" />
          <button onClick={onCategory} className="hover:text-blue-600 font-medium transition-colors">
            {category.title}
          </button>
        </>
      )}
      {item && (
        <>
          <ChevronRight className="w-4 h-4" />
          <span className="text-gray-800 font-semibold truncate max-w-xs">{item.title}</span>
        </>
      )}
    </nav>
  );
};

// --- COMPONENTE DE CÓDIGO MEJORADO ---
const CodeBlock = ({ code }) => {
  const highlightCode = (str) => {
    if (!str) return '';
    return str.split('\n').map((line, i) => {
      // Comentarios (Líneas completas)
      if (line.trim().startsWith('--') || line.trim().startsWith('//')) {
        return <div key={i} className="text-gray-500 italic font-mono">{line}</div>;
      }
      
      const parts = line.split(/(\s+|[(),;])/g);
      return (
        <div key={i}>
          {parts.map((part, j) => {
            const upperPart = part.toUpperCase();
            // Palabras Clave SQL
            if (['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'UPDATE', 'SET', 'INSERT', 'INTO', 'VALUES', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'ON', 'GROUP', 'BY', 'ORDER', 'HAVING', 'LIMIT', 'UNION', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'NOT', 'EXISTS', 'DISTINCT', 'AS', 'NULL'].includes(upperPart)) {
              return <span key={j} className="text-blue-400 font-bold">{part}</span>;
            }
            // Funciones SQL
            if (['NOW', 'COUNT', 'MAX', 'MIN', 'AVG', 'SUM', 'CONCAT', 'IF', 'IFNULL', 'DATE_FORMAT', 'DATEDIFF', 'ADDDATE', 'SUBSTR', 'CAST', 'AES_DECRYPT', 'AES_ENCRYPT'].includes(upperPart)) {
               return <span key={j} className="text-purple-400">{part}</span>;
            }
            return <span key={j}>{part}</span>;
          })}
        </div>
      );
    });
  };

  return (
    <pre className="bg-slate-900 text-gray-100 p-6 rounded-xl overflow-x-auto text-sm font-mono leading-6 border border-slate-700 shadow-inner custom-scrollbar relative">
      <div className="absolute top-0 left-0 bg-slate-800 text-xs text-gray-400 px-3 py-1 rounded-br-lg font-mono">SQL / Code</div>
      <code className="block mt-4">{highlightCode(code)}</code>
    </pre>
  );
}

// --- TEXTO RESALTADO EN BÚSQUEDA ---
const HighlightedText = ({ text, highlight }) => {
  if (!highlight) return <span>{text}</span>;
  const parts = text.split(new RegExp(`(${highlight})`, 'gi'));
  return (
    <span>
      {parts.map((part, i) => 
        part.toLowerCase() === highlight.toLowerCase() ? 
          <span key={i} className="bg-yellow-200 text-gray-900 font-semibold px-0.5 rounded">{part}</span> : 
          part
      )}
    </span>
  );
};

// --- CHAT WIDGET (AI MOCK) ---
const ChatWidget = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([
    { id: 1, text: "Hola, soy tu asistente de BC Novanet. ¿En qué puedo ayudarte hoy?", sender: 'bot' }
  ]);
  const [inputText, setInputText] = useState("");
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isTyping]);

  const handleSendMessage = () => {
    if (!inputText.trim()) return;

    const userMessage = { id: Date.now(), text: inputText, sender: 'user' };
    setMessages(prev => [...prev, userMessage]);
    setInputText("");
    setIsTyping(true);

    // AI Mock Logic
    setTimeout(() => {
      const lowerInput = userMessage.text.toLowerCase();
      let responseText = "Lo siento, no encontré información específica sobre eso. ¿Puedes intentar con otras palabras clave?";
      let foundItems = [];

      // Search Logic
      KNOWLEDGE_BASE.forEach(cat => {
        cat.items.forEach(item => {
          if (
            item.title.toLowerCase().includes(lowerInput) ||
            (item.tags && item.tags.some(t => t.toLowerCase().includes(lowerInput)))
          ) {
            foundItems.push(item);
          }
        });
      });

      if (foundItems.length > 0) {
        const links = foundItems.slice(0, 3).map(i => `• ${i.title}`).join('\n');
        responseText = `He encontrado ${foundItems.length} coincidencias que podrían ser útiles:\n\n${links}`;
      } else if (lowerInput.includes('hola') || lowerInput.includes('buenos dias')) {
        responseText = "¡Hola! Estoy listo para buscar consultas SQL o procedimientos por ti.";
      }

      setMessages(prev => [...prev, { id: Date.now() + 1, text: responseText, sender: 'bot' }]);
      setIsTyping(false);
    }, 1500);
  };

  return (
    <div className="fixed bottom-6 right-6 z-40 flex flex-col items-end">
      {/* Chat Window */}
      {isOpen && (
        <div className="bg-white w-80 md:w-96 h-[500px] rounded-2xl shadow-2xl border border-gray-200 flex flex-col mb-4 animate-fade-in-up overflow-hidden">
          {/* Header */}
          <div className="bg-blue-600 p-4 flex justify-between items-center text-white">
            <div className="flex items-center space-x-2">
              <div className="p-1.5 bg-white/20 rounded-full">
                <Sparkles className="w-4 h-4" />
              </div>
              <div>
                <h3 className="font-bold text-sm">Asistente IA</h3>
                <p className="text-xs text-blue-100 flex items-center">
                  <span className="w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                  En línea
                </p>
              </div>
            </div>
            <button onClick={() => setIsOpen(false)} className="hover:bg-white/20 p-1 rounded transition-colors">
              <X className="w-5 h-5" />
            </button>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
            {messages.map((msg) => (
              <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm ${
                  msg.sender === 'user' 
                    ? 'bg-blue-600 text-white rounded-br-none' 
                    : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none'
                }`}>
                  <p className="whitespace-pre-wrap">{msg.text}</p>
                </div>
              </div>
            ))}
            {isTyping && (
              <div className="flex justify-start">
                <div className="bg-white border border-gray-200 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm flex items-center space-x-1">
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="p-4 bg-white border-t border-gray-100">
            <div className="flex items-center space-x-2">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                placeholder="Escribe tu consulta..."
                className="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none"
              />
              <button 
                onClick={handleSendMessage}
                disabled={!inputText.trim()}
                className="p-2.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
              >
                <Send className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* FAB Button */}
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className={`p-4 rounded-full shadow-lg transition-all transform hover:scale-105 ${isOpen ? 'bg-gray-700 rotate-90' : 'bg-gradient-to-r from-blue-600 to-indigo-600'} text-white`}
      >
        {isOpen ? <X className="w-6 h-6" /> : <MessageSquare className="w-6 h-6" />}
      </button>
    </div>
  );
};

// --- COMPONENTES PRINCIPALES ---

const Sidebar = ({ activeTab, setActiveTab, categories }) => {
  return (
    <div className="w-64 bg-slate-900 text-white flex flex-col h-full fixed left-0 top-0 overflow-y-auto z-10 hidden md:flex border-r border-slate-700">
      <div className="p-6 flex items-center space-x-3 border-b border-slate-700 bg-slate-900 sticky top-0 z-20">
        <Database className="w-8 h-8 text-blue-400" />
        <span className="font-bold text-lg tracking-tight">BC Novanet - BBDD</span>
      </div>

      <nav className="flex-1 px-3 py-6 space-y-1">
        <button
          onClick={() => setActiveTab('dashboard')}
          className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors mb-4 ${
            activeTab === 'dashboard' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
          }`}
        >
          <Home className="w-5 h-5" />
          <span className="font-medium">Inicio</span>
        </button>

        <div className="px-4 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center">
          <Hash className="w-3 h-3 mr-1" /> Módulos
        </div>

        {categories.map((cat) => (
          <button
            key={cat.id}
            onClick={() => setActiveTab(cat.id)}
            className={`w-full flex items-center space-x-3 px-4 py-2.5 rounded-lg transition-all duration-200 group ${
              activeTab === cat.id ? 'bg-slate-800 text-blue-400 border-r-4 border-blue-500' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
            }`}
          >
            <div className={`transition-colors ${activeTab === cat.id ? 'text-blue-400' : 'text-slate-500 group-hover:text-white'}`}>
              {cat.icon}
            </div>
            <span className="font-medium text-sm truncate">{cat.title}</span>
          </button>
        ))}
      </nav>
      
      <div className="p-4 border-t border-slate-800 text-xs text-slate-500 text-center bg-slate-900 sticky bottom-0">
        v8.0 - AI Chat Integration
      </div>
    </div>
  );
};

const MobileHeader = ({ setActiveTab, isMenuOpen, setIsMenuOpen }) => (
  <div className="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center fixed w-full z-20 shadow-md">
    <div className="flex items-center space-x-2">
      <Database className="w-6 h-6 text-blue-400" />
      <span className="font-bold text-lg">BC Novanet - BBDD</span>
    </div>
    <button onClick={() => setIsMenuOpen(!isMenuOpen)}>
      {isMenuOpen ? <X /> : <Menu />}
    </button>
  </div>
);

const SearchBar = ({ searchTerm, setSearchTerm }) => (
  <div className="relative mb-8 group">
    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
      <Search className="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
    </div>
    <input
      type="text"
      className="block w-full pl-11 pr-4 py-4 bg-white border border-gray-200 rounded-xl leading-5 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-all text-base"
      placeholder="Buscar en Módulos (título, descripción, código SQL)..."
      value={searchTerm}
      onChange={(e) => setSearchTerm(e.target.value)}
    />
  </div>
);

const DashboardStats = ({ data }) => {
  const totalItems = data.reduce((acc, cat) => acc + cat.items.length, 0);
  const sqlItems = data.reduce((acc, cat) => acc + cat.items.filter(i => i.type === 'SQL').length, 0);
  const procItems = data.reduce((acc, cat) => acc + cat.items.filter(i => i.type === 'Procedure').length, 0);

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
        <div className="p-3 bg-blue-100 text-blue-600 rounded-lg">
          <Database className="w-6 h-6" />
        </div>
        <div>
          <p className="text-sm text-gray-500 font-medium">Total Recursos</p>
          <h3 className="text-2xl font-bold text-gray-900">{totalItems}</h3>
        </div>
      </div>
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
        <div className="p-3 bg-purple-100 text-purple-600 rounded-lg">
          <Terminal className="w-6 h-6" />
        </div>
        <div>
          <p className="text-sm text-gray-500 font-medium">Consultas SQL</p>
          <h3 className="text-2xl font-bold text-gray-900">{sqlItems}</h3>
        </div>
      </div>
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
        <div className="p-3 bg-orange-100 text-orange-600 rounded-lg">
          <Activity className="w-6 h-6" />
        </div>
        <div>
          <p className="text-sm text-gray-500 font-medium">Procedimientos</p>
          <h3 className="text-2xl font-bold text-gray-900">{procItems}</h3>
        </div>
      </div>
    </div>
  );
};

const DashboardCard = ({ category, onClick }) => (
  <div 
    onClick={onClick}
    className="bg-white rounded-xl shadow-sm border border-gray-100 p-5 cursor-pointer hover:shadow-lg hover:border-blue-300 hover:-translate-y-1 transition-all group duration-300 flex items-start space-x-4 h-full"
  >
    <div className={`p-3 rounded-lg ${category.color} bg-opacity-10 text-opacity-100 flex-shrink-0`}>
       <div className={`${category.color.replace('bg-', 'text-')} font-bold`}>
         {category.icon}
       </div>
    </div>
    <div className="flex-1 min-w-0">
        <h3 className="text-base font-bold text-gray-800 mb-1 group-hover:text-blue-600 transition-colors truncate">{category.title}</h3>
        <p className="text-xs text-gray-500">{category.items.length} páginas</p>
    </div>
    <ChevronRight className="w-5 h-5 text-gray-300 self-center group-hover:text-blue-500 transition-colors" />
  </div>
);

const DetailView = ({ item, onBack, categoryTitle, showToast }) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(item.content);
    setCopied(true);
    showToast("Contenido copiado al portapapeles");
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="animate-fade-in-up">
      <div className="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
        <div className="border-b border-gray-100 bg-gray-50/80 p-6 flex justify-between items-start sticky top-0 z-10 backdrop-blur-md">
          <div className="w-full">
            <div className="flex flex-col md:flex-row md:items-center md:space-x-3 mb-2">
              <h2 className="text-2xl font-bold text-gray-800">{item.title}</h2>
              <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium mt-2 md:mt-0 w-fit ${item.type === 'SQL' ? 'bg-blue-100 text-blue-800' : item.type === 'Procedure' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}`}>
                {item.type}
              </span>
            </div>
            <div className="flex gap-2 flex-wrap">
              {item.tags && item.tags.map(tag => (
                <span key={tag} className="text-xs bg-white border border-gray-200 text-gray-600 px-2 py-0.5 rounded shadow-sm">#{tag}</span>
              ))}
            </div>
          </div>
        </div>

        <div className="p-8 space-y-8">
          {(item.description || item.note) && (
            <div>
              <h4 className="text-xs uppercase tracking-wider text-gray-500 font-bold mb-3 flex items-center">
                 <Info className="w-4 h-4 mr-2" />
                 Información
              </h4>
              <div className="bg-blue-50/50 p-5 rounded-xl border border-blue-100/50 flex flex-col gap-4">
                 {item.description && (
                   <div className="flex items-start text-gray-700 leading-relaxed">
                     <AlertCircle className="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" />
                     <p>{item.description}</p>
                   </div>
                 )}
                 {item.note && (
                   <div className="flex items-start text-sm text-yellow-800 bg-yellow-50 p-3 rounded-lg border border-yellow-200/60">
                     <AlertTriangle className="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" />
                     <p className="whitespace-pre-line">{item.note}</p>
                   </div>
                 )}
              </div>
            </div>
          )}

          {item.content && (
            <div>
              <div className="flex justify-between items-center mb-3">
                 <h4 className="text-xs uppercase tracking-wider text-gray-500 font-bold flex items-center">
                   <Terminal className="w-4 h-4 mr-2" />
                   Código Técnico
                 </h4>
                 <button 
                   onClick={handleCopy}
                   className={`flex items-center px-4 py-2 text-xs font-bold rounded-lg transition-all shadow-sm ${copied ? 'bg-green-500 text-white' : 'bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300'}`}
                 >
                   {copied ? <Check className="w-3.5 h-3.5 mr-1.5" /> : <Copy className="w-3.5 h-3.5 mr-1.5" />}
                   {copied ? 'Copiado' : 'Copiar'}
                 </button>
              </div>
              <div className="relative group shadow-md rounded-xl">
                <CodeBlock code={item.content} />
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const App = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [toastMsg, setToastMsg] = useState('');

  const showToast = (msg) => {
    setToastMsg(msg);
  };

  const searchResults = useMemo(() => {
    if (!searchTerm) return [];
    const lowerTerm = searchTerm.toLowerCase();
    return KNOWLEDGE_BASE.flatMap(cat => 
      cat.items.filter(item => 
        item.title.toLowerCase().includes(lowerTerm) ||
        (item.description && item.description.toLowerCase().includes(lowerTerm)) ||
        (item.content && item.content.toLowerCase().includes(lowerTerm)) ||
        (item.note && item.note.toLowerCase().includes(lowerTerm)) ||
        item.tags.some(tag => tag.toLowerCase().includes(lowerTerm))
      ).map(item => ({...item, categoryTitle: cat.title, categoryColor: cat.color}))
    );
  }, [searchTerm]);

  const currentCategory = KNOWLEDGE_BASE.find(cat => cat.id === activeTab);

  const handleGoHome = () => {
    setActiveTab('dashboard');
    setSelectedItem(null);
    setSearchTerm('');
  };

  const handleGoCategory = () => {
    setSelectedItem(null);
  };

  const renderContent = () => {
    if (selectedItem) {
      return (
        <>
          <Breadcrumbs 
            category={KNOWLEDGE_BASE.find(c => c.title === selectedItem.categoryTitle) || currentCategory}
            item={selectedItem}
            onHome={handleGoHome}
            onCategory={handleGoCategory}
          />
          <DetailView 
            item={selectedItem} 
            onBack={() => setSelectedItem(null)} 
            categoryTitle={selectedItem.categoryTitle || currentCategory?.title}
            showToast={showToast}
          />
        </>
      );
    }

    if (searchTerm) {
      return (
        <div className="animate-fade-in">
          <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <Search className="w-5 h-5 mr-2 text-blue-500" />
            Resultados para "<span className="text-blue-600">{searchTerm}</span>"
          </h2>
          {searchResults.length === 0 ? (
            <div className="text-center py-20 bg-gray-50 rounded-xl border-dashed border-2 border-gray-200">
              <p className="text-gray-500">No se encontraron resultados.</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {searchResults.map((item) => (
                <div 
                  key={item.id}
                  onClick={() => setSelectedItem(item)}
                  className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md cursor-pointer transition-all group"
                >
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="flex items-center space-x-2 mb-2">
                        <span className={`text-xs px-2 py-0.5 rounded font-medium ${item.categoryColor.replace('bg-', 'bg-').replace('500', '100').replace('600', '100')} ${item.categoryColor.replace('bg-', 'text-').replace('500', '800').replace('600', '800')}`}>
                          {item.categoryTitle}
                        </span>
                        <h3 className="font-bold text-gray-800 group-hover:text-blue-600 transition-colors">
                          <HighlightedText text={item.title} highlight={searchTerm} />
                        </h3>
                      </div>
                      <p className="text-sm text-gray-500 line-clamp-2">
                        {item.description ? <HighlightedText text={item.description} highlight={searchTerm} /> : (item.note ? <HighlightedText text={item.note} highlight={searchTerm} /> : 'Sin descripción')}
                      </p>
                    </div>
                    <ChevronRight className="text-gray-300 group-hover:text-blue-500" />
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    if (activeTab === 'dashboard') {
      return (
        <div className="animate-fade-in">
          <div className="mb-10 text-center md:text-left">
            <h1 className="text-4xl font-extrabold text-slate-900 mb-3 tracking-tight">Centro de Gestión</h1>
            <p className="text-lg text-slate-500">Base de conocimiento técnica centralizada.</p>
          </div>
          
          <DashboardStats data={KNOWLEDGE_BASE} />

          <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <Hash className="w-5 h-5 mr-2 text-gray-400" /> Acceso Rápido a Módulos
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-10">
            {KNOWLEDGE_BASE.map(cat => (
              <DashboardCard 
                key={cat.id} 
                category={cat} 
                onClick={() => setActiveTab(cat.id)} 
              />
            ))}
          </div>
        </div>
      );
    }

    if (currentCategory) {
      return (
        <div className="animate-fade-in">
           <Breadcrumbs category={currentCategory} onHome={handleGoHome} />
           
           <div className="flex items-center space-x-4 mb-8 mt-4">
             <div className={`p-4 rounded-2xl ${currentCategory.color} text-white shadow-lg`}>
                {React.cloneElement(currentCategory.icon, { className: "w-8 h-8" })}
             </div>
             <div>
               <h1 className="text-3xl font-bold text-gray-900">{currentCategory.title}</h1>
               <p className="text-gray-500 text-lg">Explorando páginas del módulo</p>
             </div>
           </div>

           <div className="grid grid-cols-1 gap-4">
             {currentCategory.items.map((item) => (
                <div 
                  key={item.id}
                  onClick={() => setSelectedItem(item)}
                  className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-blue-300 hover:shadow-lg hover:-translate-y-0.5 cursor-pointer transition-all group duration-200"
                >
                  <div className="flex justify-between items-start">
                     <div className="flex-1 pr-4">
                       <div className="flex items-center space-x-3 mb-2 flex-wrap gap-y-2">
                         <h3 className="text-lg font-bold text-gray-800 group-hover:text-blue-600 transition-colors">{item.title}</h3>
                         <span className={`text-xs px-2.5 py-0.5 rounded-full font-medium ${item.type === 'SQL' ? 'bg-blue-50 text-blue-600' : item.type === 'Procedure' ? 'bg-purple-50 text-purple-600' : 'bg-gray-100 text-gray-800'}`}>
                           {item.type}
                         </span>
                       </div>
                       <p className="text-gray-500 mb-4 line-clamp-2">{item.description || item.note}</p>
                     </div>
                     <div className="self-center">
                        <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">
                           <ChevronRight className="w-5 h-5 text-gray-300" />
                        </div>
                     </div>
                  </div>
                </div>
             ))}
           </div>
        </div>
      );
    }

    return null;
  };

  return (
    <div className="flex h-screen bg-gray-50 font-sans text-gray-900 selection:bg-blue-100 selection:text-blue-900 relative">
      {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg('')} />}
      <ChatWidget />
      
      <Sidebar 
        activeTab={activeTab} 
        setActiveTab={(tab) => { setActiveTab(tab); setSelectedItem(null); setSearchTerm(''); setIsMenuOpen(false); }} 
        categories={KNOWLEDGE_BASE}
      />
      
      {isMenuOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}>
          <div className="bg-slate-900 w-3/4 h-full p-4 shadow-2xl overflow-y-auto" onClick={e => e.stopPropagation()}>
             <div className="space-y-2 mt-12">
                <button onClick={() => {setActiveTab('dashboard'); setIsMenuOpen(false)}} className="block text-white font-bold text-lg p-3 bg-blue-600 rounded-lg w-full text-left">Inicio</button>
                {KNOWLEDGE_BASE.map(cat => (
                   <button key={cat.id} onClick={() => {setActiveTab(cat.id); setIsMenuOpen(false)}} className="block text-gray-400 p-3 hover:text-white hover:bg-slate-800 rounded-lg transition-colors w-full text-left">{cat.title}</button>
                ))}
             </div>
          </div>
        </div>
      )}

      <div className="flex-1 flex flex-col h-full overflow-hidden relative bg-gray-50/50">
        <MobileHeader setActiveTab={setActiveTab} isMenuOpen={isMenuOpen} setIsMenuOpen={setIsMenuOpen} />
        
        <main className="flex-1 overflow-y-auto p-4 md:p-8 pt-20 md:pt-8 scroll-smooth">
          <div className="max-w-6xl mx-auto pb-10">
            <SearchBar searchTerm={searchTerm} setSearchTerm={setSearchTerm} />
            {renderContent()}
          </div>
        </main>
      </div>
    </div>
  );
};

export default App;